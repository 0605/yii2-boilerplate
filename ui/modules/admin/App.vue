<template>
  <div id="app">
    <div v-if="isErrorMessageVisible" id="errorMessage" />
    <login-modal v-if="isLoginModalVisible" :visible="true" />
    <router-view />
  </div>
</template>

<script>
import LoginModal from '@admin/components/LoginModal'

let lastLoginAction = ''
let lastErrorMessage = ''

export default {
  name: 'App',
  spinnerTimeoutId: 0,
  components: { LoginModal },
  computed: {
    isErrorMessageVisible() {
      const self = this
      const error = self.$store.state.error
      const currentPath = this.$router.currentRoute.path
      const isHome = currentPath === '/' || currentPath === '/home'

      if (error.message.length > 0 && error.message !== lastErrorMessage) {
        lastErrorMessage = error.message

        self.$alert(error.message, {
          center: true,
          confirmButtonText: error.historyBack ? '返回' : '确定',
          type: 'warning',
          showClose: false,
          callback: () => {
            lastErrorMessage = ''
            self.$store.dispatch('clearError')

            if (error.historyBack === true && !isHome) {
              self.$router.back()
            }
          },
        })
      }

      return false
    },
    isLoginModalVisible() {
      const action = this.$store.getters['auth/getLoginAction']

      if (lastLoginAction === action) {
        return false
      }

      lastLoginAction = action

      if (action === 'direct') {
        const router = this.$router
        const loginUrl = '/login'

        this.$message({
          message: '需要登录才能访问',
          type: 'warning',
          duration: 2000,
        })

        if (router.currentRoute.path === loginUrl) {
          router.replace(router.currentRoute.fullPath)
        } else {
          router.replace({
            path: loginUrl,
            query: { direct: router.currentRoute.fullPath },
          })
        }
      }

      return action === 'modal'
    },
  },
  beforeCreate() {
    this.$store.dispatch('auth/initClientId')
  },
  mounted() {
    this.spinnerTimeoutId = setTimeout(() => {
      const spinner = document.getElementById('spinner')

      if (spinner) {
        spinner.remove()
      }
    }, 900)
  },
  destroyed() {
    if (this.spinnerTimeoutId > 0) {
      clearTimeout(this.spinnerTimeoutId)
    }
  },
}
</script>

<style lang="scss">
@import '../../core/assets/styles/base.scss';
@import './assets/styles/style.scss';
</style>
